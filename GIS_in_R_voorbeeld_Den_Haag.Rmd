---
title: 'GIS in R: casestudy Den Haag'
author: "Elisabeth van der Meijde"
date: "19 januari 2018"
output: html_document
code_folding: show
---

```{r setup, include=FALSE}
# libraries
require(knitr)
opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=TRUE, warning=FALSE, message=FALSE, cache=TRUE)
```

## Samenvatting
Om te laten zien dat GIS mogelijk is in R, gebruiken we wat open geodata van Den Haag, en maken een map.

## Inleiding
Den Haag heeft een aantal kaarten openbaar gemaakt. Wij gebruiken de kaart van blokverwarming, energielabels (p5), en combineren deze met open satellietdata van NASA, en een open street map.

## Data
Eerst downloaden en upzippen we de shapefiles van geoportaal-ddh.
```{r file downloads ed}
# file download & unzip
download.file("http://geoportaal-ddh.opendata.arcgis.com/datasets/9cca53a6a4094a0b80e964b181a484ad_3.zip","blokverwarming.zip", mode="wb")
unzip("blokverwarming.zip")
download.file("http://geoportaal-ddh.opendata.arcgis.com/datasets/ed833f69fb82463ea63d37be00c356c3_0.zip", "energielabels.zip", mode="wb")
unzip("energielabels.zip")

# inputfileblokverwarming
f_blokverwarming <- "blokverwarming_DH.shp"
# inputfile enegielabels
f_energielabels <- "Energielabels_Postcode_5_niveau_Den_Haag_2016.shp"

```

## Kaart Energielabels
We lezen de file in met readOGR van package rgdal. En daarna plotten we de polygons met wat kleurtjes, met behulp van base plot.
```{r plot energielabels}
require(rgdal)
# de layers uit de shapefile
fl_energielabels <- ogrListLayers(f_energielabels) ## het is er slechts 1
# lees de layer in met readOGR
energielabels <- readOGR(f_energielabels,layer=fl_energielabels[1])
# plot de kaart
plot(energielabels,col=colorRampPalette(c("brown", "grey"))(5))
```
We willen natuurlijk graag laten zien wat de gemiddelde energielabels zijn per p5 gebied. Daarvoor gebruiken we de library tmap. Daarmee kun je vergelijkbaar met ggplot een kaart samenstellen.
```{r tmap energielabels}
require(tmap)
tm_shape(energielabels) +
  tm_polygons("MEAN_label", style="jenks", alpha=.5, palette=colorRampPalette(c("green", "red"))(5)) +
  tm_compass(type="arrow", position=c("right", "top"), fontsize = 2 ) + 
  tm_scale_bar()
```
## Kaart Blokverwarming
We proberen de file weer in te lezen met readOGR.
```{r readOGR blokverwarming}
blokverwarming <- readOGR(f_blokverwarming)   # geeft een error
```
Die geeft een error, omdat blokverwarming een multiploint shapefile is. Dat formaat kan niet worden ingelezen met package gdal. We gebruiken st_read uit package sf. NB readOGR heeft de voorkeur, mits die bruikbaar is natuurlijk. Vervolgens plotten we de punten met behulp van base plot.
```{r st_read blokverwarming}
require(sf)
blokverwarming <- st_read(f_blokverwarming)
plot(blokverwarming$geometry,pch='.')
```
## Kaart Energielabels met Blokverwarming
Met behulp van base plot kunnen we de punten van blokverwarming over de p5 van energielabels heen.
```{r plot base energielabels en blokverwarming}
# wat gevogel met x en y coordinaten uit het sf object halen
x_blok <- rep(1.1,length(blokverwarming$geometry[[1]])/2)
y_blok <- rep(1.1,length(blokverwarming$geometry[[1]])/2)
for (i in 1:length(blokverwarming$geometry[[1]])/2)
{
  x_blok[i] <-  blokverwarming$geometry[[1]][i,][1]
  y_blok[i] <-  blokverwarming$geometry[[1]][i,][2]
  i=i+1
}
blokverwarming_xy <- as.data.frame(cbind(x_blok,y_blok))
# plot
plot(energielabels,col=colorRampPalette(c("brown", "grey"))(5))
points(blokverwarming_xy,pch='.',col="blue")
```
We willen natuurlijk liever zo'n mooie tm_=_map plot maken. Maar hoe?